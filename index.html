<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Secure Notes App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      background: #181a1b;
      color: #e4e6eb;
    }
    .form-label { margin-bottom: 0.2rem;}
    .table-dark th, .table-dark td { vertical-align: middle; }
    .note-row.selected { background: #2c2f33 !important; }
    .note-row:hover { background: #23272b !important; cursor:pointer;}
    .bi { vertical-align: -.125em; }
    .btn-icon { padding: 0.3rem 0.5rem; }
    .custom-switch { cursor:pointer; }
    .searchbar { max-width: 350px;}
    .export-instructions { font-size: 0.9em; color: #aaa;}
    input, textarea { background: #23272b !important; color: #e4e6eb !important; }
    input:focus, textarea:focus { background: #2c2f33 !important; color: #e4e6eb !important; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-journal-richtext"></i> Secure Notes</h2>
    <div>
      <span class="me-2">Dark Mode</span>
      <input id="toggleDark" class="form-check-input custom-switch" type="checkbox" checked>
    </div>
  </div>
  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <button class="btn btn-success" onclick="showAddNoteModal()"><i class="bi bi-plus"></i> New Note</button>
    <button class="btn btn-outline-secondary" onclick="exportNotes()"><i class="bi bi-download"></i> Export</button>
    <label class="btn btn-outline-secondary mb-0">
      <i class="bi bi-upload"></i> Import
      <input type="file" accept=".json" onchange="importNotes(event)" hidden>
    </label>
    <input type="text" id="searchInput" class="form-control searchbar ms-auto" oninput="renderNotes()" placeholder="Search notes...">
  </div>
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>User Name</th>
          <th>Password</th>
          <th>Key</th>
          <th>Notes</th>
          <th style="width: 90px;">Actions</th>
        </tr>
      </thead>
      <tbody id="notesTableBody"></tbody>
    </table>
  </div>
  <div class="export-instructions mt-2">
    <b>Export/Import:</b> Download your notes as a JSON file. To email them to yourself (e.g., Gmail), export, then attach the file to your email. To import notes, use the Import button and select a previously saved notes file.
  </div>
</div>

<!-- Modal for Add/Edit Note -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="noteForm" onsubmit="saveNote(event)">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalLabel">Add Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="noteId">
        <div class="mb-2">
          <label for="noteName" class="form-label">Name</label>
          <input type="text" class="form-control" id="noteName" required maxlength="60">
        </div>
        <div class="mb-2">
          <label for="noteUsername" class="form-label">User Name</label>
          <input type="text" class="form-control" id="noteUsername" maxlength="60">
        </div>
        <div class="mb-2">
          <label for="notePassword" class="form-label">Password</label>
          <input type="text" class="form-control" id="notePassword" maxlength="60">
        </div>
        <div class="mb-2">
          <label for="noteKey" class="form-label">Key</label>
          <input type="text" class="form-control" id="noteKey" maxlength="60">
        </div>
        <div class="mb-2">
          <label for="noteText" class="form-label">Notes</label>
          <textarea class="form-control" id="noteText" rows="4" maxlength="1200"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap 5 JS Bundle (with Popper for modal) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let notes = [];
let editNoteId = null;

// Load notes from localStorage
function loadNotes() {
  let data = localStorage.getItem('notes_v2');
  try {
    notes = data ? JSON.parse(data) : [];
  } catch {
    notes = [];
  }
}
function saveNotes() {
  localStorage.setItem('notes_v2', JSON.stringify(notes));
}

// Render notes in the table
function renderNotes() {
  const tbody = document.getElementById('notesTableBody');
  const search = (document.getElementById('searchInput').value || '').toLowerCase();
  tbody.innerHTML = '';
  notes
    .filter(note =>
      !search ||
      Object.values(note).some(v => v && v.toLowerCase().includes(search))
    )
    .sort((a,b) => b.created - a.created)
    .forEach((note, idx) => {
      const date = new Date(note.created).toLocaleString();
      const row = document.createElement('tr');
      row.className = 'note-row';
      row.innerHTML = `
        <td>${date}</td>
        <td>${escapeHTML(note.name)}</td>
        <td>${escapeHTML(note.username)}</td>
        <td>${escapeHTML(note.password)}</td>
        <td>${escapeHTML(note.key)}</td>
        <td>${escapeHTML(note.text)}</td>
        <td>
          <button class="btn btn-sm btn-primary btn-icon me-1" title="Edit" onclick="showEditNoteModal(${note.id});event.stopPropagation();"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-danger btn-icon" title="Delete" onclick="deleteNote(${note.id});event.stopPropagation();"><i class="bi bi-trash"></i></button>
        </td>
      `;
      row.onclick = () => showEditNoteModal(note.id);
      tbody.appendChild(row);
    });
}

// Show modal to add a new note
function showAddNoteModal() {
  editNoteId = null;
  document.getElementById('noteModalLabel').textContent = 'Add Note';
  document.getElementById('noteForm').reset();
  document.getElementById('noteId').value = '';
  new bootstrap.Modal(document.getElementById('noteModal')).show();
}

// Show modal to edit a note
function showEditNoteModal(id) {
  const note = notes.find(n => n.id === id);
  if (!note) return;
  editNoteId = id;
  document.getElementById('noteModalLabel').textContent = 'Edit Note';
  document.getElementById('noteId').value = id;
  document.getElementById('noteName').value = note.name;
  document.getElementById('noteUsername').value = note.username;
  document.getElementById('notePassword').value = note.password;
  document.getElementById('noteKey').value = note.key;
  document.getElementById('noteText').value = note.text;
  new bootstrap.Modal(document.getElementById('noteModal')).show();
}

// Add or update note
function saveNote(e) {
  e.preventDefault();
  const id = document.getElementById('noteId').value;
  const note = {
    id: id ? parseInt(id) : Date.now(),
    created: id ? notes.find(n => n.id === parseInt(id)).created : Date.now(),
    name: document.getElementById('noteName').value.trim(),
    username: document.getElementById('noteUsername').value.trim(),
    password: document.getElementById('notePassword').value.trim(),
    key: document.getElementById('noteKey').value.trim(),
    text: document.getElementById('noteText').value.trim()
  };
  if (id) {
    // Update
    const idx = notes.findIndex(n => n.id === note.id);
    if (idx >= 0) notes[idx] = note;
  } else {
    // New
    notes.push(note);
  }
  saveNotes();
  renderNotes();
  bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
}

// Delete note
function deleteNote(id) {
  if (!confirm('Delete this note?')) return;
  notes = notes.filter(n => n.id !== id);
  saveNotes();
  renderNotes();
}

// Export notes as JSON file
function exportNotes() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notes, null, 2));
  const a = document.createElement('a');
  a.setAttribute("href", dataStr);
  a.setAttribute("download", "secure-notes.json");
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Import notes from JSON file
function importNotes(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (!Array.isArray(imported)) throw new Error('Invalid format');
      // Merge, avoiding duplicate ids
      const ids = new Set(notes.map(n => n.id));
      imported.forEach(n => {
        if (!ids.has(n.id)) notes.push(n);
      });
      saveNotes();
      renderNotes();
      alert('Import successful!');
    } catch {
      alert('Invalid file or format.');
    }
  };
  reader.readAsText(file);
  event.target.value = "";
}

// Dark mode toggle
document.getElementById('toggleDark').addEventListener('change', function() {
  document.documentElement.setAttribute('data-bs-theme', this.checked ? 'dark' : 'light');
  localStorage.setItem('notes_dark', this.checked ? '1' : '');
});

// Apply dark mode from localStorage
if (localStorage.getItem('notes_dark') === '') {
  document.getElementById('toggleDark').checked = false;
  document.documentElement.setAttribute('data-bs-theme', 'light');
}

// Simple HTML escaping
function escapeHTML(str) {
  return (str || '').replace(/[&<>"']/g, function(m) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m];
  });
}

// Initial load
loadNotes();
renderNotes();

</script>
</body>
</html>
